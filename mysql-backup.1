.\" Automatically generated by Pandoc 1.19.2.1
.\"
.ad b
.TH "mysql\-backup" "1" "2017\-10\-02 19:56:04" "mysql\-backup" "User manual"
.hy
.SH NAME
.PP
mysql\-backup \- Backup MySQL databases.
.SH SYNOPSIS
.PP
mysql\-backup [ options ] [ \-\-dump | \-\-snapshot ]
.SH DESCRIPTION
.PP
\f[I]mysql\-backup\f[] performs daily, weekly and monthly backup of
MySQL databases.
Features:
.IP \[bu] 2
Backup multiple databases
.IP \[bu] 2
Compress backup files
.IP \[bu] 2
Backup remote servers
.IP \[bu] 2
Rotate backups
.IP \[bu] 2
more...
.SH ARGUMENTS
.SS Options
.TP
.B \-c CONFIG, \-\-config CONFIG
A configuration file to use instead of default one.
This option allows different configuration for different MySQL servers.
.RS
.RE
.TP
.B \-v, verbose
Run in verbose mode.
.RS
.RE
.TP
.B \-h, \-\-help
Show a short help screen.
.RS
.RE
.TP
.B \-\-dry\-run
Run in \f[I]dry\-run\f[] mode, do not perform any action.
.RS
.RE
.TP
.B \-\-dump, \-d
Do a \f[I]mysqldump\f[] backup.
.RS
.RE
.TP
.B \-\-snapshot, \-s
Perform a binary backup using \f[I]lvm\f[] snapshot.
.RS
.RE
.PP
NOTE: To restore a LVM snapshot you just need to untar the archive.
.SH CONFIGURATION FILE
.SS Default configuration
.PP
\f[I]mysql\-backup\f[] looks for a default configuration file in that
order:
.IP \[bu] 2
\f[C]/etc/mysql\-backup/default.cnf\f[]
.IP \[bu] 2
\f[C]~/.mysql\-backup.cnf\f[]
.IP \[bu] 2
\f[C]\&./.mysql\-backup.cnf\f[]
.PP
If no default configuration file is found, default hard\-coded values
would be used.
.SS Specific configuration file
.PP
In addition of the default configuration, a specific configuration file
can be used (with the \f[C]\-\-conf\f[] option).
.SS General options
.TP
.B BACKUP_DIR
Where the backups files would be stored.
A generic backup file schema is:
.RS
.PP
<BACKUP_DIR>/<host>/<binary|dump>/<daily|weekly|monthly>/<base>_YYYY\-MM\-DD.sql[.<COMPRESSION_EXTENSION>]
.RE
.SS MySQL options
.TP
.B DATABASES
Databases to backup.
If this value is set to \f[I]ALL\f[] then all databases would be
backuped.
\f[I]mysql\-backup\f[] would determine the database using the "SHOW
DATABASES" query.
.RS
.RE
.TP
.B IGNORE_DATABASES
A list of database to ignore during backup.
By default, \f[I]information_schema\f[] and \f[I]performance_schema\f[]
are ignored.
.RS
.RE
.PP
In addition to that option all mysql(1) and mysqldump(1) options are
also recognized as long as dash (\f[C]\-\f[]) are changed to underscore
(\f[C]_\f[]).
.PP
NOTE: However some options are not recognized: \f[I]help\f[],
\f[I]pipe\f[], \f[I]table\f[], \f[I]version\f[], \f[I]databases\f[],
\f[I]ignore\-table\f[], \f[I]ssl\f[], \f[I]execute\f[].
.PP
EXAMPLE: This is the default MySQL configuration:
.IP
.nf
\f[C]
batch=1
skip_column_names=1
quote_names=1
opt=1
add_drop_database=1
\f[]
.fi
.PP
EXAMPLE: If you use \f[I]mysqld_multi\f[] you can defined a common
complex configuration file (ie.
\f[I]/etc/mysql\-backup/__multi\-defaults.inc\f[]) such as:
.IP
.nf
\f[C]
BACKUP_DIR=/var/backups/mysql/
\ HOST=articles${_instance}
TARGET_MOUNT=/tmp/$HOST\-bck
LVM_SNAPSHOT_SIZE="100G"
mysql_instance=mysqld${_instance}
proto=SOCKET
socket=/var/run/mysqld/mysqld_${_instance}.sock
tar_opts=""
mysqladmin_extra_file=/etc/mysql/debian_${_instance}.cnf
user=$(${my_print_defaults}\ \-c\ ${mysqladmin_extra_file}\ client\ |\ awk\ \-F=\ \[aq]{if($1~/^\-\-user$/){print\ $2}}\[aq])
password=$(${my_print_defaults}\ \-c\ ${mysqladmin_extra_file}\ client\ |\ awk\ \-F=\ \[aq]{if($1~/^\-\-password$/){print\ $2}}\[aq])
\f[]
.fi
.PP
and an instance specific configuration in
(\f[I]/etc/mysql\-backup/instance00.cnf\f[]):
.IP
.nf
\f[C]
instance=00
source\ /etc/mysql\-backup/__multi\-defaults.inc
\f[]
.fi
.PP
And a cron such as:
.IP
.nf
\f[C]
01\ 00\ *\ *\ *\ root\ mysql\-backup\ \-c\ /etc/mysql\-backup/instance00.cnf\ \-\-snapshot
\f[]
.fi
.TP
.B SUFFIX
Suffix to \f[I]datadir_path\f[] when creating a snapshot backup.
You can safely leave it empty if you are using default mysql
configuration.
If you are using your own layout you should use this option.
.RS
.RE
.PP
EXAMPLE: If your layout is something like that:
.IP
.nf
\f[C]
\ /var/lib/mysql/db_00
\ |\-\-\ binlog
\ |\-\-\ config
\ |\ \ \ |\-\-\ conf.d
\ |\ \ \ |\ \ \ `\-\-\ mysql\-multi.cnf
\ |\ \ \ |\-\-\ debian.cnf
\ |\ \ \ |\-\-\ my.cnf
\ |\ \ \ `\-\-\ mysql\-backup.cnf
\ |\-\-\ data
\ |\ \ \ |\-\-\ aria_log.00000001
\ |\ \ \ |\-\-\ aria_log_control
\ |\ \ \ |\-\-\ mysql
\ |\ \ \ |\-\-\ relay\-log.info
\ |\ \ \ |\-\-\ show\-master\-status
\ |\ \ \ `\-\-\ show\-slave\-status
\ |\-\-\ log
\ |\-\-\ mysql\-multi.txt
\ `\-\-\ tmp
\f[]
.fi
.PP
\f[I]datadir_path\f[] is pointing to \f[I]/var/lib/mysql/db_00/data\f[]
but you also want to backup other files so you have to set
\f[I]SUFFIX\f[] to \f[I]..\f[].
.SS Archive options
.TP
.B COMPRESSION
The tool to use for compression.
Currently \f[I]gzip\f[], \f[I]pigz\f[], \f[I]bzip2\f[] and \f[I]xz\f[]
are recognized.
If compression if not known then no compression would be used.
.RS
.RE
.PP
NOTE: \f[I]gzip\f[] generates bigger files than the others but needs
less CPU time.
.TP
.B COMPRESSION_OPTS
Options to pass to the compression tool.
.RS
.RE
.TP
.B DAILY_RETENTION
How many days a daily backup should be kept.
By default daily archives are kept 7 days.
.RS
.RE
.TP
.B WEEKLY_RETENTION
How many days a weekly backup should be kept.
By default weekly archives are kept 35 days (5 weeks).
.RS
.RE
.TP
.B MONTHLY_RETENTION
How many days a monthly backup should be kept.
By default monthly archives are kept 365 days (12 months).
.RS
.RE
.TP
.B WEEKLY_DAY
Which day weekly backup are done (0..6, 0 is Sunday).
.RS
.RE
.TP
.B MONTHLY_DAY
Which day monthly backup are done (00..31).
.RS
.RE
.TP
.B HOST
Name of the host to backup for logging purposes.
.RS
.RE
.PP
NOTE: This is not the mysql host to backup (use "host" in lowercase for
that).
.SS LVM Options
.TP
.B LVM_EXT
Extension for the LVM snapshot (Default: "_bkp") that would be added to
the current LVM volume name.
.RS
.RE
.TP
.B LVCREATE_OPTS
Options to pass to lvcreate(1) when doing LVM snapshot (Default:
"\-\-chunksize=256").
.RS
.RE
.TP
.B LVREMOVE_OPTS
Options to pass to lvremove(1) when purging a snapshot (Default: "\-f").
.RS
.RE
.TP
.B TARGET_MOUNT
Where to mount the LVM snapshot before archiving the data (Default:
"/tmp/mysql\-snapshot").
.RS
.RE
.SS Hooks
.PP
Hooks are scripts that can be run via run\-parts(8).
Each hook parameter consists of a directory path suitable for
run\-parts(8).
.PP
See run\-parts(8) for further information on how hooks are run.
.PP
See \f[I]HOOK DETAILS\f[] section for details.
.SH ARCHIVE PROCEDURE
.PP
Every day backups are done in the \f[I]daily\f[] directory.
On \f[I]WEEKLY_DAY\f[] the daily backup is hard linked to the
\f[I]weekly\f[] directory (the same is done for monthly backups on
\f[I]MONTHLY_DAY\f[] and \f[I]monthly\f[] directory).
.PP
After that archives older that \f[I]DAILY_RETENTION\f[],
\f[I]WEEKLY_RETENTION\f[] and \f[I]MONTHLY_RETENTION\f[] are removed
from their specific directories.
.PP
This system keeps space on the backup server by the use of hard links.
.PP
NOTE: This only works if all backups are in a single partition.
.SS How is this done?
.PP
First \f[I]mysql\-backup\f[] generate a \f[I]LVM\f[] snapshot of the
\f[I]mysql\f[] you want to backup.
During that snapshot creation the replication is stopped, the tables are
locked ("FLUSH TABLES WITH READ LOCK").
Then the current replication status (for both master and slave) are
dumped into mysql \f[I]datadir\f[] in files
\f[I]show\-master\-status\f[] and \f[I]show\-slave\-status\f[].
.PP
For each kind of backup (snapshot or dump) an other \f[I]mysqld\f[]
instance is started using the new \f[I]lvm\f[] snapshot as
\f[I]datadir\f[].
This will ensure the rebuild of innodb journal and indexes.
Then the archive process is run (\f[I]mysqldump\f[] for dump and
\f[I]tar\f[] for snapshot).
.PP
NOTE: For big databases you\[aq]d better want to use a snapshot backup
since the archive process would be faster and the restoration either.
.PP
Once every backup are done, the \f[I]lvm\f[] snapshot is removed.
.SH Restoration procedure
.PP
For binary snapshot you only need to untar the archive on a new server
to create a clone.
.PP
For dump backups, you need to replay every database files, such as:
.IP
.nf
\f[C]
zcat\ base_YYY\-MM\-DD.sql.gz\ |\ mysql\ \-
\f[]
.fi
.SH HOOKS DETAILS
.SS Dump hooks
.TP
.B pre_dump_backup_hook
Hook to be run before the dump backup process really starts.
.RS
.RE
.TP
.B post_dump_backup_hook
Hook to be run after the dump backup process is done.
.RS
.RE
.TP
.B pre_dump_restore_hook
Hook to be run before the dump restore process really starts.
.RS
.RE
.TP
.B post_dump_restore_hook
Hook to be run after the dump restore process is done.
.RS
.RE
.PP
NOTE: In addition hook names could be postfixed with a database name.
This means a hook could be defined for a specific database.
.PP
EXAMPLE: \f[I]post_dump_backup_hook_a_database\f[] is ran before
\f[I]a_database\f[] would be backuped.
.SS Snapshot hooks
.TP
.B pre_snapshot_backup_hook
Hook to be run before a snapshot really stats.
.RS
.RE
.TP
.B post_snapshot_backup_hook
Hook to be run when a snapshot is done.
.RS
.RE
.TP
.B pre_snapshot_backup_lvm_snaphost_hook
Hook to be run before the LVM snapshot is started.
.RS
.RE
.TP
.B post_snapshot_backup_lvm_snaphost_hook
Hook to be run after the LVM snapshot is done.
.RS
.RE
.TP
.B pre_snapshot_backup_archive_hook
Hook to be run before the archive process is started.
.RS
.RE
.TP
.B post_snapshot_backup_archive_hook
Hook to be run after the archive process is done.
.RS
.RE
.PP
NOTE: There is no database postfix for snapshot hooks since there would
be nonsense.
.SH SEE ALSO
.IP \[bu] 2
mysql(1)
.IP \[bu] 2
mysqldump(1)
.IP \[bu] 2
gzip(1), bzip2(1), xz(1)
.IP \[bu] 2
run\-parts(8)
.SH HISTORY
.SS Version XX
.IP \[bu] 2
Add PID to log entries.
.IP \[bu] 2
Enhance log messages.
.IP \[bu] 2
Enhance launch of temporary mysql instance.
.IP \[bu] 2
Add support for pigz (http://zlib.net/pigz/).
.IP \[bu] 2
Add SUFFIX option for multi\-instance mysql backup.
.SS Version 2.2
.PP
2015\-02\-02:
.IP \[bu] 2
Wait if blocked queries are longer than 10s.
.SS Version 2.0
.PP
2014\-03\-06:
.IP \[bu] 2
rewrite the core application.
.IP \[bu] 2
bump to version 2.0
.SS Version 1.9
.PP
2012\-06\-04:
.IP \[bu] 2
Add replication information for dumps
.IP \[bu] 2
Add snapshot option
.IP \[bu] 2
Add \f[I]LVCREATE_OPTS\f[]
.SS Version 1.0
.PP
2010\-09\-06:
.PP
First release.
.SH BUGS
.PP
No time to include bugs, command actions might seldom lead astray
user\[aq]s assumption.
.SH COPYRIGHT
.PP
Copyright © 2010\-2017 Sébastien Gross <seb•ɑƬ•chezwam•ɖɵʈ•org>.
.PP
Released under GNU GPL version 3 or
higher (http://www.gnu.org/licenses/gpl.html).
.SH AUTHORS
Sébastien Gross <seb•ɑƬ•chezwam•ɖɵʈ•org> (\f[B]\@renard_0\f[]).
